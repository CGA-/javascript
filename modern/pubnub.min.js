// 3.4.2
(function(){
function l(){return function(){}}var m=1,n=!1,s=[],t="-pnpres",y=1E3,aa=/{([\w\-]+)}/g;function ba(){return"x"+ ++m+""+ +new Date}function C(){return+new Date}var D,F=Math.floor(20*Math.random());D=function(a,b){return 0<a.indexOf("pubsub.")&&a.replace("pubsub","ps"+(b?J().split("-")[0]:20>++F?F:F=1))||a};function ca(a,b){function d(){e+b>C()?(clearTimeout(c),c=setTimeout(d,b)):(e=C(),a())}var c,e=0;return d}function da(a,b){var d=[];K(a||[],function(a){b(a)&&d.push(a)});return d}
function ea(a,b){return a.replace(aa,function(a,c){return b[c]||a})}function J(a){var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:b&3|8).toString(16)});a&&a(b);return b}function K(a,b){if(a&&b)if("undefined"!=typeof a[0])for(var d=0,c=a.length;d<c;)b.call(a[d],a[d],d++);else for(d in a)a.hasOwnProperty&&a.hasOwnProperty(d)&&b.call(a[d],d,a[d])}function L(a,b){var d=[];K(a||[],function(a,e){d.push(b(a,e))});return d}
function M(a){return L(encodeURIComponent(a).split(""),function(a){return 0>"-_.!~*'()".indexOf(a)?a:"%"+a.charCodeAt(0).toString(16).toUpperCase()}).join("")}function P(a){var b=[];K(a,function(a,c){c.f&&b.push(a)});return b.sort()}function fa(){setTimeout(function(){n||(n=1,K(s,function(a){a()}))},y)}
function Q(a){function b(a){e||(e=1,clearTimeout(A),c&&(c.onerror=c.onload=null,c.abort&&c.abort(),c=null),a&&u())}function d(){if(!E){E=1;clearTimeout(A);try{response=JSON.parse(c.responseText)}catch(a){return b(1)}p(response)}}var c,e=0,E=0,A;A=setTimeout(function(){b(1)},R);var u=a.b||l(),p=a.c||l();try{c="undefined"!==typeof XDomainRequest&&new XDomainRequest||new XMLHttpRequest;c.onerror=c.onabort=function(){b(1)};c.onload=c.onloadend=d;c.timeout=R;url=a.url.join(ga);if(a.data){var g=[];url+=
"?";for(key in a.data)g.push(key+"="+a.data[key]);url+=g.join(ha)}c.open("GET",url,!0);c.send()}catch(B){return b(0),Q(a)}return b}function S(a,b,d){K(a.split(","),function(a){function e(a){a||(a=window.event);d(a)||(a.cancelBubble=!0,a.returnValue=!1,a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation())}b.addEventListener?b.addEventListener(a,e,!1):b.attachEvent?b.attachEvent("on"+a,e):b["on"+a]=e})}
function T(a){function b(){}function d(a){K(P(i),function(b){(b=i[b])&&a(b)})}function c(a){a&&(j.g=0);!j.g&&j.length&&(j.g=1,q(j.shift()))}a.db=U;a.xdr=Q;var e,E=+a.windowing||10,A=(+a.timeout||310)*y,u=(+a.keepalive||60)*y,p=a.publish_key||"",g=a.subscribe_key||"",B=a.ssl?"s":"",z="http"+B+"://"+(a.origin||"pubsub.pubnub.com"),v=D(z),V=D(z),j=[],W=0,X=0,N=0,O=0,Y=0,G=0,i={},q=a.xdr,ia=a._is_online||function(){return 1},r=a.jsonp_cb||function(){return 0},w=a.db||{get:l(),set:l()},x=a.uuid||w&&w.get(g+
"uuid")||"",f={_reset_offline:function(){N&&N(1)},LEAVE:function(a,b){var c={uuid:x},d=D(z),e=r();0<a.indexOf(t)||("0"!=e&&(c.callback=e),q({l:b||B,timeout:2E3,a:e,data:c,url:[d,"v2","presence","sub_key",g,"channel",M(a),"leave"]}))},history:function(a,b){var b=a.callback||b,c=a.count||a.limit||100,d=a.reverse||"false",e=a.error||l(),f=a.channel,I=a.start,i=a.end,h={},k=r();if(!f)return error("Missing Channel");if(!b)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");h.stringtoken=
"true";h.count=c;h.reverse=d;k&&(h.callback=k);I&&(h.start=I);i&&(h.end=i);q({a:k,data:h,c:function(a){b(a)},b:e,url:[v,"v2","history","sub-key",g,"channel",M(f)]})},replay:function(a){var b=b||a.callback||l(),c=a.source,d=a.destination,e=a.stop,f=a.start,i=a.end,j=a.reverse,a=a.limit,h=r(),k={};if(!c)return error("Missing Source Channel");if(!d)return error("Missing Destination Channel");if(!p)return error("Missing Publish Key");if(!g)return error("Missing Subscribe Key");"0"!=h&&(k.callback=h);
e&&(k.stop="all");j&&(k.reverse="true");f&&(k.start=f);i&&(k.end=i);a&&(k.count=a);q({a:h,c:function(a){b(a)},b:function(){b([0,"Disconnected"])},url:[v,"v1","replay",p,g,c,d],data:k})},time:function(a){var b=r();q({a:b,timeout:5*y,url:[v,"time",b],c:function(b){a(b[0])},b:function(){a(0)}})},publish:function(a,b){var b=b||a.callback||l(),d=a.message,e=a.channel,f=r();if(!d)return error("Missing Message");if(!e)return error("Missing Channel");if(!p)return error("Missing Publish Key");if(!g)return error("Missing Subscribe Key");
d=JSON.stringify(d);e=[v,"publish",p,g,0,M(e),f,M(d)];j.push({a:f,timeout:5*y,url:e,data:{uuid:x},c:function(a){b(a);c(1)},b:function(){b([0,"Failed",d]);c(1)}});c()},unsubscribe:function(a){a=a.channel;G=0;O=1;a=L((a.join?a.join(","):""+a).split(","),function(a){return a+","+a+t}).join(",");K(a.split(","),function(a){n&&f.LEAVE(a,0);i[a]=0});n&&b()},subscribe:function(a,c){function e(a){a?setTimeout(j,y):(v=D(z,1),V=D(z,1),setTimeout(function(){f.time(e)},y));d(function(b){if(a&&b.d)return b.d=0,
b.j(b.name);!a&&!b.d&&(b.d=1,b.i(b.name))})}function j(){var a=r(),b=P(i).join(",");b&&(N=q({timeout:B,a:a,b:function(){f.time(e)},data:{uuid:x},url:[V,"subscribe",g,M(b),a,G],c:function(a){if(!a)return setTimeout(j,Z);d(function(a){a.e||(a.e=1,a.h(a.name))});G=!G&&O&&w.get(g)||a[1];w.set(g,a[1]);var b,c=(2<a.length?a[2]:"").split(",");b=function(){var a=c.shift()||"";return[(i[a]||{}).a||W,(a||X).split(t)[0]]};K(a[0],function(c){var d=b();if(i[d[1]].f)d[0](c,a,d[1])});setTimeout(j,Z)}}))}var H=a.channel,
c=(c=c||a.callback)||a.message,p=a.connect||l(),I=a.reconnect||l(),u=a.disconnect||l(),h=a.presence||0,k=a.noheresync||0,B=a.timeout||A,Z=a.windowing||E;a.restore&&(O=1);if(!H)return error("Missing Channel");if(!c)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");K((H.join?H.join(","):""+H).split(","),function(a){var b=i[a]||{};i[X=a]={name:a,e:b.e,d:b.d,f:1,a:W=c,h:p,i:u,j:I};h&&(f.subscribe({channel:a+t,callback:h}),!b.f&&!k&&f.here_now({channel:a,callback:function(b){K("uuids"in
b?b.uuids:[],function(c){h({action:"join",uuid:c,timestamp:C(),occupancy:b.occupancy||1},b,a)})}}))});b=function(){f._reset_offline();clearTimeout(Y);Y=setTimeout(j,100)};if(!n)return s.push(b);b()},here_now:function(a,b){var b=a.callback||b,c=a.error||l(),d=a.channel,e=r(),f=null;if(!d)return error("Missing Channel");if(!b)return error("Missing Callback");if(!g)return error("Missing Subscribe Key");"0"!=e&&(f={},f.callback=e);q({a:e,data:f,c:function(a){b(a)},b:c,url:[v,"v2","presence","sub_key",
g,"channel",M(d)]})},xdr:q,ready:fa,db:w,uuid:J,each:K,map:L,grep:da,supplant:ea,now:C,unique:ba,updater:ca,poll_online:function(){ia()||f._reset_offline();setTimeout(f.poll_online,y)},poll_online2:function(){f.time(function(a){a||f._reset_offline();setTimeout(f.poll_online2,u)})}};x||(x=f.uuid());w.set(g+"uuid",x);setTimeout(f.poll_online,y);setTimeout(f.poll_online2,u);e=f;e.init=T;if(a.notest)return e;S("beforeunload",window,function(){each_channel(function(a){e.LEAVE(a.name,1)});return!0});S("offline",
window,e._reset_offline);S("offline",document,e._reset_offline);e.ready();return e}var ga="/",ha="&",R=31E4,U,$="undefined"!=typeof localStorage&&localStorage;U={get:function(a){try{return $?$.getItem(a):-1==document.cookie.indexOf(a)?null:((document.cookie||"").match(RegExp(a+"=([^;]+)"))||[])[1]||null}catch(b){}},set:function(a,b){try{if($)return $.setItem(a,b)&&0;document.cookie=a+"="+b+"; expires=Thu, 1 Aug 2030 20:00:00 UTC; path=/"}catch(d){}}};
"undefined"!==typeof module&&(module.m=T)||"undefined"!==typeof exports&&(exports.k=T)||(PUBNUB=T);
})();
